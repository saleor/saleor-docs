---
title: Stripe
---

Stripe plugin uses [custom payment flow](https://stripe.com/docs/payments/accept-a-payment?platform=web&ui=elements) to process customer transactions.

:::note
Saleor uses Stripe API in version [2020-08-27](https://stripe.com/docs/upgrades#2020-08-27)
:::

## Creating payment in Saleor

To create a payment properly, you need to follow the steps described in 
[Creating a checkout session](developer/checkout.mdx#creating-a-checkout-session) and 
[Selecting a shipping method](developer/checkout.mdx#selecting-a-shipping-method).

The next step is to choose Stripe as a payment gateway that we want to use to process checkout. 
For the Stripe payment gateway, we need to provide: `checkoutId`, and `input` with `gateway` and `amount`.

:::note

Description of the `checkoutPaymentCreate` mutation can be found [here](developer/checkout.mdx#selecting-a-payment-method).

:::

```graphql
mutation {
  checkoutPaymentCreate(
    checkoutId: "Q2hlY2tvdXQ6MWZiMmM1OGUtN2JhMy00YmY5LWI2ZDItNWY2ZWJiN2U3ZWJj"
    input: { gateway: "saleor.payments.stripe", amount: 45.61 }
  ) {
    payment {
      id
      chargeStatus
    }
    errors {
      field
      message
    }
  }
}

```

## Completing the checkout
After we create a payment object for the Stripe payment gateway, 
we can call the `checkoutComplete` mutation.  The first call of `checkoutComplete` for checkout
 creates [Stripe payment intent object](https://stripe.com/docs/api/payment_intents/object).

Optionaly, `checkoutComplete` can accept additional parameters for Stripe as fields in `paymentData` input:

- `paymentData.setup_future_usage` - Store payment method in Stripe for [future usage](https://stripe.com/docs/api/payment_intents/object#payment_intent_object-setup_future_usage).
- `paymentData.off_session` - When [off_session](https://stripe.com/docs/api/payment_intents/create#create_payment_intent-off_session) is set to True, [confirm](https://stripe.com/docs/api/payment_intents/create#create_payment_intent-confirm)=True will be also attached to request.
- `paymentData.payment_method_id` - [ID of the payment method](https://stripe.com/docs/api/payment_intents/create#create_payment_intent-payment_method) which should be used for this payment.
- `paymentData.payment_method_type` - [List of payment method types that should be supported by this payment](https://stripe.com/docs/api/payment_intents/create#create_payment_intent-payment_method_types). Default: `["card"]`


:::note
`paymentData.payment_method_type` - accepts all standard payment method types which use standard PaymentIntent flow to process a payment. [For more details check Stripe docs.](https://stripe.com/docs/payments/payment-methods/overview)
:::


 ```graphql
mutation {
  checkoutComplete(
    checkoutId: "Q2hlY2tvdXQ6YjBhYTUzMWItYjc3NS00MzM3LTkxNzEtYTgzOTYwYThjMmVk"
  ) {
    order {
      id
      userEmail
      created
    }
    confirmationNeeded
    confirmationData
    errors {
      field
      message
      code
    }
  }
}
 ```

 As a result, we get details required to finalize a payment.

```json
{
  "data": {
    "checkoutComplete": {
      "order": null,
      "confirmationNeeded": true,
      "confirmationData": "{\"client_secret\": \"pi_1J2Yh3H1Vac4G4dbfuBvQhTe_secret_DkwP8jcdenirqazGpjPvSaPtV\", \"id\": \"pi_1J2Yh3H1Vac4G4dbfuBvQhTe\"}",
      "checkoutErrors": []
    }
  }
}
```
`client_secret` is required to process a customer payment.
Steps required to finalize a payment transaction are described in [Stripe documentation](https://stripe.com/docs/payments/accept-a-payment?platform=web&ui=elements).

#### Saving card in Stripe for future payments
Use `paymentData.setup_future_usage` to store payment method for future payments

```graphql
mutation {
  checkoutComplete(
    checkoutId: "ID"
    storeSource: true
    paymentData: "{\"setup_future_usage\": \"off_session\"}"
  ) {
    order {
      id
      userEmail
      created
    }
    confirmationNeeded
    confirmationData
    errors {
      field
      message
      code
    }
  }
}
```

#### Using stored payment method
Use `paymentData.payment_method_id` and `paymentData.off_session` to use stored payment method
```graphql
mutation {
  checkoutComplete(
    checkoutId: "ID"
    storeSource: true
    paymentData: "{\"payment_method_id\": \"pm_id\", \"off_session\": false}"
  ) {
    order {
      id
      userEmail
      created
    }
    confirmationNeeded
    confirmationData
    errors {
      field
      message
      code
    }
  }
}
```



### Finalizing a payment
When the customer finalizes a payment, Stripe sends a webhook notification with all details 
related to this payment. Saleor asynchronously receives the notification and 
completes checkout process.

On client-side, when `stripe.confirmCardPayment` doesn't return an error as 
[described here](https://stripe.com/docs/payments/accept-a-payment?platform=web&ui=elements#web-submit-payment),  
client-side can call  `checkoutComplete` one more time.
Saleor confirms that the payment has success status and returns an order object.

 ```graphql
mutation {
  checkoutComplete(
    checkoutId: "Q2hlY2tvdXQ6YjBhYTUzMWItYjc3NS00MzM3LTkxNzEtYTgzOTYwYThjMmVk"
  ) {
    order {
      id
      userEmail
      created
    }
    confirmationNeeded
    confirmationData
    errors {
      field
      message
      code
    }
  }
}
```

As a result we get order object.
```json
{
  "data": {
    "checkoutComplete": {
      "order": {
        "id": "T3JkZXI6MjI0Mw==",
        "userEmail": "m...@mirumee.com",
        "created": "2021-06-04T09:24:44.552881+00:00"
      },
      "confirmationNeeded": false,
      "confirmationData": "{}",
      "checkoutErrors": []
    }
  }
}
```

## Stripe webhooks

By activating a plugin, Saleor automatically subscribes the following Stripe webhook events:

- `payment_intent.succeeded`
- `payment_intent.processing`
- `payment_intent.payment_failed`
- `payment_intent.amount_capturable_updated`
- `payment_intent.canceled`
- `charge.refunded`
