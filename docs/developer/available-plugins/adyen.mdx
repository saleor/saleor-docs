---
title: Adyen
---

Adyen plugin allows you to process customer transactions via [Adyen](https://www.adyen.com). 
The list of available payments methods can be found [here](https://docs.adyen.com/payment-methods)

:::note
Saleor uses Adyen's checkout API in version [64](https://docs.adyen.com/api-explorer/#/CheckoutService/v64/overview). 
If you're using [drop-in](https://docs.adyen.com/online-payments/web-drop-in/integrated-before-5-0-0) or 
[components](https://docs.adyen.com/online-payments/web-components/integrated-before-5-0-0) integrations make sure that 
you're using Adyen's packages in a version lower than 5.0.0.
:::


:::note
To use Adyen plugin, make sure that you configured the plugin. 
The configuration is described [here](dashboard/configuration/plugins/adyen.md#enabling-the-adyen-integration).
:::


## Adding a payment form

Adding a payment form for Adyen requires Saleor to provide available payment methods and client-key. 
Both of these values can be fetched by calling `checkout.availablePaymentGateways.config`. 
The query returns all required fields to prepare a payment form with methods available for the checkout.

```graphql
{
  checkout(token:"14f11c1c-9bc7-4145-89f7-67b60ef943f2"){
    availablePaymentGateways{
      id
      config{
        field
        value
      }
    }
  }
}
```
 As a result, we get details required to render a payment form.

 ```json
 {
  "data": {
    "checkout": {
      "availablePaymentGateways": [
        {
          "id": "mirumee.payments.adyen",
          "config": [
            {
              "field": "client_key",
              "value": "test_BBDTBL6GWVEJTOXY55TSPJFP54QBIOZ5"
            },
            {
              "field": "config",
              "value": "{\"groups\": [{\"name\": \"Credit Card\", \"types\": [\"visa\", \"mc\", \"amex\", \"diners\", \"discover\"]}], \"paymentMethods\": [{\"brands\": [\"visa\", \"mc\", \"amex\", \"diners\", \"discover\"], \"details\": [{\"key\": \"encryptedCardNumber\", \"type\": \"cardToken\"}, {\"key\": \"encryptedSecurityCode\", \"type\": \"cardToken\"}, {\"key\": \"encryptedExpiryMonth\", \"type\": \"cardToken\"}, {\"key\": \"encryptedExpiryYear\", \"type\": \"cardToken\"}, {\"key\": \"holderName\", \"optional\": true, \"type\": \"text\"}], \"name\": \"Credit Card\", \"supportsRecurring\": true, \"type\": \"scheme\"}, {\"configuration\": {\"intent\": \"capture\"}, \"name\": \"PayPal\", \"supportsRecurring\": true, \"type\": \"paypal\"}, {\"name\": \"Paysafecard\", \"supportsRecurring\": true, \"type\": \"paysafecard\"}, {\"configuration\": {\"merchantDisplayName\": \"SaleorECOM\", \"merchantIdentifier\": \"1000\"}, \"details\": [{\"key\": \"applepay.token\", \"type\": \"applePayToken\"}], \"name\": \"Apple Pay\", \"supportsRecurring\": true, \"type\": \"applepay\"}, {\"configuration\": {\"merchantId\": \"1000\", \"gatewayMerchantId\": \"SaleorECOM\"}, \"details\": [{\"key\": \"paywithgoogle.token\", \"type\": \"payWithGoogleToken\"}], \"name\": \"Google Pay\", \"supportsRecurring\": true, \"type\": \"paywithgoogle\"}]}"
            }
          ]
        }
      ]
    }
  }
}
 ```

## Creating payment in Saleor

To create a payment properly, you need to follow the steps described in 
[Creating a checkout session](developer/checkout.mdx#creating-a-checkout-session) and 
[Selecting a shipping method](developer/checkout.mdx#selecting-a-shipping-method).

The next step is to choose Adyen as a payment gateway that we want to use to process checkout. 
For the Adyen payment gateway, we need to provide:

- `checkoutId`: ID of the checkout, for which new payment should be created.

- `input.gateway`: ID of the payment gateway which should be assigned to this payment. For Adyen it will be:  `mirumee.payments.adyen`.

- `input.amount`: Amount of payment to process.

- `input.returnUrl`: URL to where the shopper should be taken back to after a redirection.


:::note
Description of the `checkoutPaymentCreate` mutation can be found [here](developer/checkout.mdx#selecting-a-payment-method).
:::

```graphql
mutation {
  checkoutPaymentCreate(
    checkoutId: "Q2hlY2tvdXQ6MWZiMmM1OGUtN2JhMy00YmY5LWI2ZDItNWY2ZWJiN2U3ZWJj"
    input: { gateway: "mirumee.payments.adyen", amount: 45.61, returnUrl: "https://127.0.0.1:3000/checkout/payment-confirm" }
  ) {
    payment {
      id
      chargeStatus
    }
    errors {
      field
      message
    }
  }
}
```

## Completing the checkout
After we create a payment object for the Adyen payment gateway, 
we can call the `checkoutComplete` mutation.

`checkoutComplete` can accept additional parameters for Adyen as fields in `paymentData` input. 
Below fields in `paymentData` will be directly passed to Adyen's [payments endpoint](https://docs.adyen.com/api-explorer/#/CheckoutService/v64/post/payments):

- Required:
  - `paymentMethod` - Received from front end payment form as a `state.data.paymentMethod` when a customer provides payment details. 
  [Adyen's docs](https://docs.adyen.com/api-explorer/#/CheckoutService/v64/post/payments__reqParam_paymentMethod).

- Optional:
  - `channel` - The platform where a payment transaction takes place. Default `web`. 
  [Adyen's docs](https://docs.adyen.com/api-explorer/#/CheckoutService/v64/post/payments__reqParam_channel).
  - `originUrl` - Required for the 3D Secure 2 channel `web` integration. 
  Value assigned to `origin` field. [Adyen's docs](https://docs.adyen.com/api-explorer/#/CheckoutService/v64/post/payments__reqParam_origin).
  - `browserInfo` - The shopper's browser information. 
  [Adyen's docs](https://docs.adyen.com/api-explorer/#/CheckoutService/v64/post/payments__reqParam_browserInfo).
  - `billingAddress` - The billing address of the customer. If empty or missing, 
  Saleor will fill up a field based on checkout's billing address. 
  [Adyen's docs](https://docs.adyen.com/api-explorer/#/CheckoutService/v64/post/payments__reqParam_billingAddress).
  - `deliveryAddress` - The delivery address of the customer. If empty or missing, 
  Saleor will fill up a field based on checkout's shipping address. 
  [Adyen's docs](https://docs.adyen.com/api-explorer/#/CheckoutService/v64/post/payments__reqParam_deliveryAddress).
  - `shopperIP` - The customer's IP address. [Adyen's docs](https://docs.adyen.com/api-explorer/#/CheckoutService/v64/post/payments__reqParam_shopperIP).
  - `deviceFingerprint` - A string containing the customer's device fingerprint. 
  [Adyen's docs](https://docs.adyen.com/api-explorer/#/CheckoutService/v64/post/payments__reqParam_deviceFingerprint).
  - `shopperName` - The customer's full name. [Adyen's docs](https://docs.adyen.com/api-explorer/#/CheckoutService/v64/post/payments__reqParam_shopperName).


```graphql
mutation {
  checkoutComplete(
    token: "14f11c1c-9bc7-4145-89f7-67b60ef943f2"
    paymentData: "{\"paymentMethod\": {\"type\": \"scheme\", \"encryptedCardNumber\": \"adyenjs_0_1_25$OneNKwaAZqAGM2Ksi7PLVw...\", \"encryptedExpiryMonth\": \"adyenjs_0_1_25$uablDTOYKywxbeeBdnkS...\", \"encryptedExpiryYear\": \"adyenjs_0_1_25$u8XBJQ92a//ZnAQtEvTDYqugoYtuYVmU14wEcl7DAjUS3OPcjj+hMvBlWctyKuG0aYG18L790...\", \"encryptedSecurityCode\": \"adyenjs_0_1_25$e7fZqa+exKs8ovFFPGLz+...\"}}"
  ) {
    order {
      id
    }
    confirmationNeeded
    confirmationData
  }
}
```

The checkoutComplete mutation has the below fields:
- `order` - Optional Order object. `Null` when Saleor was not able to finalize checkout or additional action is required from customer. 
- `confirmationNeeded` - Set to `true` when finalizing a checkout requires more action from the customer.
- `confirmationData` - Action data that need to be processed on the frontend side before finalizing the payment. [Adyen doc's](https://docs.adyen.com/api-explorer/#/CheckoutService/v64/post/payments__resParam_action).
- `errors` - Saleor's errors related to `checkoutComplete` action.

### Completing the checkout without requiring any additional action
When payment doesn't require any additional action from the customer, Saleor will finalize a checkout, return an order, set `confirmationNeeded` to `false` and `confirmationData` as an empty dict.

```json
{
  "data": {
    "checkoutComplete": {
      "order": {
        "id": "T3JkZXI6MjkxMw=="
      },
      "confirmationNeeded": false,
      "confirmationData": "{}"
    }
  }
}
```

### Processing a checkout's payment with required additional actions
When payment requires additional action from the customer like authentication payment with 3D Secure,
 log in to their bank's website or redirect to payment provider page, Saleor will set `confirmationNeeded` to `true` 
 and provide all Adyen's action data required to finalize payment as a `confirmationData`.

```json
{
  "data": {
    "checkoutComplete": {
      "order": {
        "id": "T3JkZXI6MjkxMw=="
      },
      "confirmationNeeded": false,
      "confirmationData": "{\"paymentData\": \"Ab02b4c0!BQABAgA1Xk1nQmoiOJCEtVVds....4n8OzNsVJGN3XHg7kMg=\",\"paymentMethodType\": \"scheme\",\"url\": \"https:\\/\\/checkoutshopper-test.adyen.com\\/checkoutshopper\\/threeDS2.shtml\",\"data\": {\"MD\": \"M2RzM...DRi\",\"PaReq\": \"BQABAg....Rz3hacE\",\"TermUrl\": \"http:\\/\\/mirumee.com\\/plugins\\/mirumee.payments.adyen\\/additional-actions?payment=UGF5bWVudDoxMDM%3D&checkout=08546530-4718-422c-a912-9a1642a9031c\"},\"method\": \"POST\",\"type\": \"redirect\"}"
    }
  }
}
```

After processing additional action by the customer, call `checkoutComplete` a second time and pass data received from Adyen (`state.data`) as a `paymentData` field:

```graphql
mutation {
  checkoutComplete(
    token: "14f11c1c-9bc7-4145-89f7-67b60ef943f2"
    paymentData: "{\"additional-action\": \"data recieved from onAdditionalDetails\" ...,\"}"
  ) {
    order {
      id
    }
    confirmationNeeded
    confirmationData
  }
}
```
The response of the mutation will contain a newly created order or additional data required for the next additional action from a customer. 
In case, when more actions are required, process them in the same way as the second `checkoutComplete` call.

#### Processing a redirect additional action

if `action.type` is `redirect`, Adyen will redirect a customer to a page where the customer can finalize the payment.
 After that customer will be redirected back. The request will go through the Saleor, which will confirm the current status of payment. 
 As a next step, Saleor will use `returnUrl` provided in `checkoutPaymentCreate` mutation to redirect shopper to store page.
The `returnUrl` will have attached below parameters:
  - Required:
    - `checkout` - the ID of processed checkout.
    - `payment` - the ID of processed payment.
    - `resultCode` - status of the payment recieved from Adyen. Can be used to determine the current status of the payment. [Docs](https://docs.adyen.com/online-payments/payment-result-codes)
  - Optional:
    - `action` -  action data if an additional action is required by customer.

If payment was successfully processed, Saleor will create an order. The next mutation `checkoutComplete` call will return `order` in the response.



## Enabling native 3DS2
Saleor by default uses redirect 3D Secure 1 and 2. To use native 3DS, [enable it in the Saleor's dashboard](dashboard/configuration/plugins/adyen.md#enabling-the-adyen-integration). 
Setting this flag will include to Adyen's request `additionalData.allow3DS2: true`, to all card transactions.
Make sure that you provide all required fields for native 3D Secure in `checkoutComplete.input.paymentData` as described [here](developer/available-plugins/adyen.mdx#completing-the-checkout). 
The fields mandatory for enabling native 3D Secure 2 can be found [here](https://docs.adyen.com/online-payments/3d-secure/native-3ds2). 
Specific channel (`iOS`, `Android`, `Web`) or solution type (`Drop-in`, `Components`) can require different fields. 


## Enabling Apple Pay

:::note
Make sure that you follow all steps required to activate Apple Pay as described [here](dashboard/configuration/plugins/adyen.md#activating-applePay)
:::

### Enabling on web channel
Each usage Apple Pay on web requires the initialization of the payment session.
Adyen's form([Drop-in](https://docs.adyen.com/payment-methods/apple-pay/web-drop-in?tab=_code_payments_code__2#drop-in-configuration), 
[Components](https://docs.adyen.com/payment-methods/apple-pay/web-component?tab=_code_payments_code__2#step-2-create-an-instance-of-the-component)) has handler `onValidateMerchant`. To request the Apple Pay session, 
call mutation `paymentInitialize` inside `onValidateMerchant`.


Mutation `paymentInitialize` accepts below fields:
- `channel`: channel slug, where the Apple Pay session should be initialized
- `gateway`: - The `gateway` is the id of the  plugin which for Adyen is  - `mirumee.payments.adyen`
- `paymentData`: JSONString with all data required to initialize session.

`PaymentData` for initializing Apple Pay session should contain the below structure.
```json
{
  "merchantIdentifier": "<your-apple-merchant-id>",
  "displayName": "Merchant ID for Saleor and Adyen",
  "domain": "The registered storefront domain",
  "validationUrl": "<validationUrl>",
  "paymentMethod": "applepay"
}
```
As a response, you will get `initializedPayment` object. The `initializedPayment.data` contains the session object which should be converted to JSON (from JSONString) and passed to the resolve method.

### Testing Apple Pay
To use the test card with Apple Pay on the web, you need to follow the [Apple's docs](https://developer.apple.com/apple-pay/sandbox-testing/).
